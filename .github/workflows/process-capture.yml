name: Process Second Brain Capture

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write

jobs:
  process-capture:
    # Only run if issue has 'capture' label
    if: contains(github.event.issue.labels.*.name, 'capture')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout M2B repo (for scripts)
        uses: actions/checkout@v4
        with:
          path: m2b

      - name: Checkout M2B-Data repo (for markdown files)
        uses: actions/checkout@v4
        with:
          repository: chrisbarkerza/M2B-Data
          token: ${{ secrets.DATA_REPO_TOKEN }}
          path: m2b-data

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd m2b/.github/scripts
          npm install

      - name: Process capture with Claude API
        id: classify
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          DATA_REPO_PATH: ../m2b-data
        run: |
          cd m2b
          node .github/scripts/process-capture.js

      - name: Commit changes
        run: |
          cd m2b-data
          git config user.name "M2B Bot"
          git config user.email "m2b-bot@users.noreply.github.com"
          git add .
          git commit -m "M2B: Process capture from issue #${{ github.event.issue.number }}" || echo "No changes to commit"
          git push
        id: commit

      - name: Comment on issue with results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the result from the classification step
            let resultComment = 'âœ“ **Capture processed successfully!**\n\n';

            // Try to read the classification result
            try {
              const result = fs.readFileSync('m2b/.github/result.json', 'utf8');
              const data = JSON.parse(result);

              resultComment += `**Classification:** ${data.category}\n`;
              resultComment += `**Confidence:** ${data.confidence}%\n`;
              resultComment += `**Location:** \`${data.location}\`\n\n`;

              if (data.additional_locations && data.additional_locations.length > 0) {
                resultComment += `**Additional locations:**\n`;
                data.additional_locations.forEach(loc => {
                  resultComment += `- \`${loc}\`\n`;
                });
                resultComment += '\n';
              }

              resultComment += 'View changes in the M2B-Data repository.';
            } catch (e) {
              resultComment += 'See commit for details.';
            }

            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: resultComment
            });

            // Close the issue
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
